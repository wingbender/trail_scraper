function closeBox(e){try{showDonate(!0)}catch(e){}}function getParameterByName(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var a=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)"),o=a.exec(t);return o?o[2]?decodeURIComponent(o[2].replace(/\+/g," ")):"":null}var canFollow;$(function(){function e(e,t,a){var o=$("#embed-code"),i=o.val();if(i.match(e)){if(a)var n=new RegExp("("+e+')="([0-9]+)"',"ig"),l=i.replace(n,'$1="'+t+'"');else var n=new RegExp("("+e+"=)[a-z]+","ig"),l=i.replace(n,"$1"+t);o.val(l),$("#iframe-preview-container").animate({opacity:0},100,function(){$("#iframe-preview-container").html(l),$("#iframe-preview-container").delay(250).animate({opacity:1},100)})}return!1}function t(e){var t=new RegExp(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i);return t.test(e)}function a(){var e=$("#invitation").val();if(0==e.length)return $("#email-error").html(translate("txtEmailBodyEmpty")).fadeIn("slow").animate({opacity:1},3e3).fadeOut("slow"),$("#invitation").focus(),!1;if(e.length<=3)return $("#invitation").focus(),!1;var a=$("#email-dest").val();return 0!=a.length&&t(a)?(e=e.substr(0,4e3),$("#invitation").val(e),$("#email-submit").prop("disabled",!0).addClass("disabled"),$("#email-working").html('<img src="https://sc.wklcdn.com/images/loading.gif"/>'),void $.ajax({url:"/wikiloc/sendEmail.do",method:"post",dataType:"json",data:{token:$("#token").val(),email:$("#email-dest").val(),invitation:encodeURIComponent(e),referer:$("#referer").val(),spa:$("#spa").val(),spat:encodeURIComponent($("#spat").val())}}).done(function(e){$("#email-working").html(""),"OK"==e.res?($('<div class="messageContainer" ><div class="message big green">&nbsp;'+e.message+"&nbsp;</div></div>").insertBefore($("#referer")).fadeIn("slow").animate({opacity:1},2e3).fadeOut("slow",function(){$("#email-submit").prop("disabled",!1).removeClass("disabled"),$(this).remove(),$("#lb-email-modal").modal("toggle")}),$("#email-dest").val(""),ga("send","pageview","/trail/sent_to_friend")):"KO"==e.res?$('<div class="messageContainer" ><div class="message red">&nbsp;'+e.message+"&nbsp;</div></div>").insertBefore($("#referer")).fadeIn("slow").animate({opacity:1},2e3).fadeOut("slow",function(){$("#email-submit").prop("disabled",!1).removeClass("disabled"),$(this).remove(),$("#email-dest").focus()}):window.location.reload()})):($("#email-error").html(translate("txtEmailEmpty")).fadeIn("slow").animate({opacity:1},3e3).fadeOut("slow"),$("#email-dest").focus(),!1)}function o(e){0==$("#lb-follow-modal").length&&($("#page").append(TemplateCache.get("#lb-follow-template")({uc:{}})),0==$("#lb-follow-modal .user-box").length&&$("#secondary .user-box").clone().find("p.uploaded").remove().end().find("p.companions").remove().end().insertAfter("#lb-follow-modal .modal-body h3"),$("#lb-follow-modal").on("shown.bs.modal",function(){$("#follow-button").on("click",function(e){e.preventDefault(),$(this).prop("disabled",!0);var t=$.ajax({url:"/wikiloc/follow.do?",method:"post",dataType:"json",data:{uid:$(this).data("uid"),fol:!0}});t.done(function(e,t,a){$("#lb-follow-modal").hide(),$("body").removeClass("modal-open")})})})),e?($("#modal-title-review").hide(),$("#modal-title-favourite").show()):($("#modal-title-favourite").hide(),$("#modal-title-review").show()),$("#lb-follow-modal").modal("show")}function i(e){var t=$.ajax({url:"/wikiloc/get-favorite-list.do?",method:"post",dataType:"json",data:{spaId:spaId}});t.done(function(t){t?e(null,t):e(new Error("Something bad happened"))})}function n(e){var t=$("#favorite-list-feedback-error");t.text(e),t.show(),setTimeout(function(){t.hide()},5e3)}function l(e,t,a,i){var l=$.ajax({url:"/wikiloc/favourite.do?",method:"post",dataType:"json",data:{sid:e,listId:t,fav:!a}});l.done(function(e){if("OK"===e.res){if(canFollow&&!a&&t==-1){var l=!0;o(l)}e.a?ga("send",{hitType:"event",eventCategory:"Favorite",eventAction:"favoriteon"}):ga("send",{hitType:"event",eventCategory:"Favorite",eventAction:"favoriteoff"}),i(null,e)}else"KO"===e.res&&(u.hide(),e.err&&n(e.err))})}function r(e,t){for(var a=h.list,o=0;o<a.length;o++)a[o].id==e&&(a[o].favorite=t)}function s(e){var t=e,a=t.firstElementChild.id;"USER_PREMIUM"===userType||a<0?l(spaId,a,!0,function(e,o){r(a,!1);var i=t.firstElementChild.classList;i&&(i.remove("icon-heart"),t.classList.remove("list-heart")),i&&(i.add("icon-heart-empty"),t.classList.add("list-heart-empty")),c(t,o),u.hide(),m(),v=!1}):(showPremiumModal(premiumModalText,"FAVORITE_LIST",!1),v=!1)}function c(e,t){var a=e.parentElement.querySelectorAll(".list-count");a.length>0&&(a[0].textContent=t.count+"/"+t.limitTrails)}function d(e){var t=e,a=t.firstElementChild.id;"USER_PREMIUM"===userType||a<0?l(spaId,a,!1,function(e,o){r(a,!0);var i=t.firstElementChild.classList;i&&(t.classList.remove("list-heart-empty"),i.remove("icon-heart-empty")),i&&(i.add("icon-heart"),t.classList.add("list-heart")),c(t,o),u.hide(),m(),v=!1}):(showPremiumModal(premiumModalText,"FAVORITE_LIST",!1),v=!1)}function m(){var e=$(".tippy-content"),t=e.find("div.list-heart-empty").length,a=e.find("div.list-heart").length,o=$("#fav-button");a>0&&!o.hasClass("added")?(o.addClass("added"),$(".icon-favorite").attr("src","https://sc.wklcdn.com/wikiloc/assets/styles/images/icons/add_list_on.svg")):0===a&&t>0&&o.hasClass("added")&&(o.removeClass("added"),$(".icon-favorite").attr("src","https://sc.wklcdn.com/wikiloc/assets/styles/images/icons/add_list.svg"))}$(".help-tooltip").tooltip(),$("#share-popover").on("click",function(e){return e.preventDefault(),!0}),$("#share-popover").popover({html:!0,placement:"top",content:function(){return $("#popover-social").html()}}),$(document).on("click",'a[href^="#"]',function(e){e.preventDefault();var t=$.attr(this,"href");$(t).length&&$("html, body").animate({scrollTop:$(t).offset().top},500,function(){window.location.hash=t})}),$(".add-review-btn").on("click",function(e){ga("send",{hitType:"event",eventCategory:"Review",eventAction:"add",transport:"beacon"})}),$(".translate-toggle-button").click(function(e){var t=$(this).offset().top-$(document).scrollTop();$(".description-translate").is(":visible")?(ga("send","event","Translate","click","Show Original"),$(".description-original").show(),$(".description-translate").hide(),$(".translate-attribution").hide(),$(".translate-toggle-button").html(translate("i18nShowTranslation"))):($(".description-original").hide(),$(".description-translate").show(),$(".translate-attribution").show(),$(".translate-toggle-button").html(translate("i18nShowOriginal"))),$(this).get(0).scrollIntoView(),window.scrollBy(0,-t)}),$("#share-popover").on("shown.bs.popover",function(){ga("send","event","/trail/share"),document.querySelector(".share-facebook").addEventListener("click",function(){ga("send",{hitType:"event",eventCategory:"Share trail",eventAction:"click",eventLabel:"Facebook"})},!1),document.querySelector(".share-twitter").addEventListener("click",function(){ga("send",{hitType:"event",eventCategory:"Share trail",eventAction:"click",eventLabel:"Twitter"})},!1),document.querySelector(".share-whatsapp").addEventListener("click",function(){ga("send",{hitType:"event",eventCategory:"Share trail",eventAction:"click",eventLabel:"WhatsApp"})});var t=document.querySelector("#email-button");t&&t.addEventListener("click",function(){ga("send",{hitType:"event",eventCategory:"Share trail",eventAction:"click",eventLabel:"Email"})});var o=document.querySelector(".share-embed:not(.login-button)");o&&o.addEventListener("click",function(){ga("send",{hitType:"event",eventCategory:"Share trail",eventAction:"click",eventLabel:"Embed"})});var i=document.querySelector(".share-qr:not(.login-button)");i&&i.addEventListener("click",function(){ga("send",{hitType:"event",eventCategory:"Share trail",eventAction:"click",eventLabel:"QR"})}),$("#embed-button").on("click",function(t){t.preventDefault(),$("#share-popover").popover("toggle");var a=$(this).attr("href");0==$(a+"-modal").length&&($("#page").append(TemplateCache.get(a+"-template")({uc:{}})),$(a+"-modal").on("shown.bs.modal",function(){$("#embed-code").focus(),"created"!=$(a+"-modal").attr("data-created")&&($(a+"-modal").attr("data-created","created"),$(".embed-options-action").bind("click",function(){var e=$(this),t=e.attr("data-swap-text");e.attr("data-swap-text",e.text()),e.text(t),$(".embed-options-container").toggle(),$("#iframe-preview-container").html($("#embed-code").val())}),$(".embed-code-size").keydown(function(e){if(8!=e.which&&9!=e.which&&37!=e.which&&39!=e.which&&46!=e.which&&0!=e.which&&(e.which<48||e.which>57))return!1}),$("#embed-map-type").on("change",function(){e("maptype",$(this).val(),!1)}),$(".embed-code-size").focusout(function(){var t=$(this).attr("data-attr"),a=$(this).val();"width"==t&&parseInt(a)<280&&(a=280,$(this).val(a)),"height"==t&&parseInt(a)<300&&(a=300,$(this).val(a)),e(t,a,!0)}),$(".embed-code-checkbox").change(function(){var t=$(this),a=t.attr("data-param"),o="off";t.prop("checked")&&(o="on"),e(a,o)}))})),$(a+"-modal").modal("show")}),$("#email-button").on("click",function(e){e.preventDefault(),$("#share-popover").popover("toggle");var t=$(this).attr("data-ref");0==$(t+"-modal").length&&($("#page").append(TemplateCache.get(t+"-template")({uc:{}})),$(t+"-modal").on("shown.bs.modal",function(){$("#email-dest").focus()}),$(document).on("submit","#email-send-form",function(e){e.preventDefault(),e.stopImmediatePropagation(),a()})),$(t+"-modal").modal("show")}),$("#qr-button").on("click",function(e){e.preventDefault(),$("#share-popover").popover("toggle");var t=$(this).attr("href");0==$(t+"-modal").length&&$("#page").append(TemplateCache.get(t+"-template")({uc:{}})),$(t+"-modal").on("shown.bs.modal",function(){$.when($.getScript("https://sc.wklcdn.com/wikiloc/assets/scripts/lib/jquery.textfill.min.js"),$.Deferred(function(e){$(e.resolve())})).done(function(){$(".modal-qr-title").textfill({explicitHeight:125,maxFontPixels:30})})}),$(t+"-modal").modal("show"),$.getScript("https://sc.wklcdn.com/wikiloc/assets/scripts/wikiloc_qr_code_generator.min.js")}),$(".login-button").on("click",function(e){top.location.hostname!==self.location.hostname&&(top.location.href=self.location.href),e.preventDefault(),$("#share-popover").popover("hide"),0==$("#lb-login-modal").length&&($("#page").append(TemplateCache.get("#lb-login-template")({uc:{}})),window.SocialLogin&&SocialLogin.init(socialLoginState()),$("#lb-login-modal").on("shown.bs.modal",function(){Recaptcha.loadRecaptcha(),$("#email").focus(),$("#viewpass-button").on("click",function(){var e=$("#password");$(this).toggleClass("active"),"text"==e.attr("type")?e.attr("type","password"):e.attr("type","text");var t=2*e.val().length;e.focus(),e[0].setSelectionRange(t,t)})}),$("#lb-login-modal").on("hide.bs.modal",function(){Recaptcha.unloadRecaptcha()})),$("#lb-login-modal").modal("show")})}),$(".login-button").on("click",function(e){top.location.hostname!==self.location.hostname&&(top.location.href=self.location.href),e.preventDefault(),0==$("#lb-login-modal").length&&($("#page").append(TemplateCache.get("#lb-login-template")({uc:{}})),window.SocialLogin&&SocialLogin.init(socialLoginState()),$("#lb-login-modal").on("shown.bs.modal",function(){Recaptcha.loadRecaptcha(),$("#email").focus(),$("#viewpass-button").on("click",function(){var e=$("#password");$(this).toggleClass("active"),"text"==e.attr("type")?e.attr("type","password"):e.attr("type","text");var t=2*e.val().length;e.focus(),e[0].setSelectionRange(t,t)})}),$("#lb-login-modal").on("hide.bs.modal",function(){Recaptcha.unloadRecaptcha()})),$("#lb-login-modal").modal("show")}),$("#companion-button").on("click",function(e){e.preventDefault();var t=$(this).attr("href");0==$(t+"-modal").length&&$("#page").append(TemplateCache.get(t+"-template")({uc:{}})),$(t+"-modal").modal("show")}),$("#morePhotos").click(function(e){e.preventDefault(),$("#list-photos").append(morePhotos),$(this).hide()}),$(".view-rating").click(function(e){e.preventDefault(),$(this).hide().parent("p").next(".rating-detail").show()}),$("#rating0").addClass("star"+$("#iRating0").val()),$("#rating1").addClass("star"+$("#iRating1").val()),$("#rating2").addClass("star"+$("#iRating2").val()),$("#comment-body").keyup(function(){$(this).val().length>4e3&&($(this).val($(this).val().substr(0,4e3)),0==$(this).siblings().length&&$(this).parent().append('<div class="message yellow small ">'+translate("txtLimitText")+"</div>"))}),$("#comment-list").on("click",".delete-comment",function(e){e.preventDefault();var t=$(this).attr("id").split("-");$.ajax({url:"/wikiloc/deleteComment.do",method:"post",data:{sid:t[2],cid:t[1]},dataType:"json"}).done(function(e){"OK"==e.res?($("#comment_"+t[1]).fadeOut("slow"),$("#ncomments-inf").text(e.ncomments)):window.location.reload()})}),$("#add-comment-form").submit(function(e){if(e.preventDefault(),$("#comment-body").val().length<=3)return $("#comment-body").focus(),!1;$(".view-rating").click(function(e){e.preventDefault(),$(this).hide().parent("p").next(".rating-detail").show()}),$("#submit-comment").prop("disabled",!0).addClass("disabled"),$("#comment-working").html('<img src="https://sc.wklcdn.com/wikiloc/images/loading.gif"></img>');var t={sid:spaId,uid:uid,body:encodeURIComponent($("#comment-body").val())};return $.ajax({url:"/wikiloc/addComment.do",method:"post",data:t,dataType:"json"}).done(function(e){"undefined"!=typeof e.html?($("#comment-list").append(e.html),$("#ncomments-inf").length>0?$("#ncomments-inf").text(e.ncomments):$("#comment-list").prepend('<h2 id="ncomments-inf">'+e.ncomments+"</h2>"),$("#comment-body").val("")):"undefined"!=typeof e.error&&1==e.error?(0==$(".login-button").length&&"undefined"!=typeof e.error_str&&$("body").append('<div class="hidden">'+e.error_str+"</div>"),$(".login-button").trigger("click")):window.location.reload(),$("#comment-working").html(""),$("#submit-comment").prop("disabled",!1).removeClass("disabled")}),!1});var u,p=$("body"),h={};$("#fav-button").click("click",function(){i(function(e,t){e||(h=t,h.literals=favoriteListTooltip,canUse||(h.list=_.filter(h.list,function(e){return e.id<0})),ListFavorites.init(t,function(e,t){if(e)throw Error("Error loading template");$("#listFavorites").append(t),u=tippy.one("#fav-button",{placement:"bottom",animation:"scale",arrow:"true",trigger:"click",allowHTML:!0,content:document.getElementById("listFavorites").innerHTML,interactive:!0,theme:"light-border"}),u.show()}),$("#fav-button").off())})}),p.on("addChildrenListFavorites",function(e,t){if(t&&t.id){var a={id:t.id,name:t.name,favorite:t.favorite,count:t.count,limitTrails:t.limitTrails,isPublic:t.isPublic};h.list=h.list.concat(a),ListFavorites.init(h,function(e,t){if(e)throw Error("Error loading template");$("#listFavorites").children().remove(),$("#listFavorites").append(t),availableLists=--availableLists<0?0:availableLists,favoriteCreateList.availableLists=availableLists+" "+translations.txtRemaining,u.destroy(),u=tippy.one("#fav-button",{placement:"bottom",animation:"scale",arrow:"true",trigger:"click",allowHTML:!0,content:document.getElementById("listFavorites").innerHTML,interactive:!0,theme:"light-border"}),u.show(),m(),setTimeout(function(){u.hide()},1500)})}}),p.on("tooManyListFavorites",function(e,t){t.err&&n(t.err),$("#list-favourites-create").remove(),u.destroy(),u=tippy.one("#fav-button",{placement:"bottom",animation:"scale",arrow:"true",trigger:"click",allowHTML:!0,content:document.getElementById("listFavorites").innerHTML,interactive:!0,theme:"light-border"})}),p.on("emptyListFavorites",function(e,t){t.err&&n(t.err)});var v=!1;p.on("click",".list-favourite-item",function(e){if(!v){e.preventDefault();var t=this;if("list-favourites-create"===$(t).attr("id"))return;v=!0;var a=$(t).find(".list-heart-empty").length>0;a?d(e.currentTarget.lastElementChild):s(e.currentTarget.lastElementChild)}}),p.on("click","#list-favourites-create",function(){u.hide(),"USER_PREMIUM"===userType?availableLists>0?showFavouriteListCreate(favoriteCreateList,!0):n(translations.txtReachedLimit):showPremiumModal(premiumModalText,"FAVORITE_LIST",!1)}),p.on("input","#createListFavourite",function(){var e=$("#createListFavourite").val().length||0;$("#list-favourite-count-chart").text(e)});var f=getParameterByName("showFollow");if(canFollow&&1==f){var g=!1;o(g)}$("#direcctions-button").click(function(e){e.preventDefault();var t=$("#start-direction").val(),a=$("#end-direction").val();t&&t.length>0?window.open("https://www.google.com/maps/dir/"+t+"/"+a,"wikiloc-directions"):!function(e){setTimeout(function(){$("#direcctions-button").prev().remove()},3e3)}($(this).parent().prepend('<div class="message yellow small ">'+translate("txtEmptyStartMessage")+"</div>"))}),$("#terms").hover(function(e){$("#terms-body").show()}),$(".confirm-delete").on("click",function(e){e.preventDefault(),0==$("#lb-confirm-modal").length&&$("#page").append(TemplateCache.get("#lb-confirm-template")({uc:{}})),$("#confirm-ok").attr("href",$(this).attr("href")),$("#delete-name").html($(this).parentsUntil("#list-wp-card").find("h1").text()),$("#lb-confirm-modal").modal("show")}),isTrail&&WeatherWikiloc.init({id:"meteo",trackId:spaId,language:language,enabled:canUse,i18n:i18nWeather})});