function transformData(o){return o.map(function(o){var a;if(o.isWMS){var e=o.url.split("?")[0],t=/layers=(.*?)(&|$)/i.exec(o.url),n=/format=(.*?)(&|$)/i.exec(o.url),c="";t.length>1&&(c=t[1]);var i="image/jpeg";n&&n.length>1&&(i=n[1]),a=L.tileLayer.wms(e,{layers:c,format:i,crs:L.CRS.EPSG4326,attribution:o.credit+' <a href="'+o.crediturl+'">'})}else{var e=decodeURIComponent(o.url).replace(/\+b\+/g,"{z}").replace(/\+a\.x\+/g,"{x}").replace(/\+a\.y\+/g,"{y}").replace(/"/g,"");a=L.tileLayer(e,{attribution:'<a href="'+o.crediturl+'">'+o.credit+"</a>",minZoom:o.minZoom,maxZoom:o.maxZoom,keepBuffer:4})}return{name:o.name,layer:a}})}function loadGeopromotionLayer(o){if(housesOnMap&&housesOnMap.length>0)for(var a=housesOnMap.pop();a;)o.removeLayer(a),a=housesOnMap.pop();var e=o.getBounds();fetchAccommodations(o,e.getSouthWest().lng,e.getSouthWest().lat,e.getNorthEast().lng,e.getNorthEast().lat,25,o.getZoom())}function fetchAccommodations(o,a,e,t,n,c,i){$("#accommCheckIcon").addClass("loading"),c||(c=10),$.getJSON("/wikiloc/tr.do",{x:a,y:e,X:t,Y:n,n:c,z:i},function(a){if(a){var e=[];"success"==a.wl.response.status&&$.merge(e,a.wl.response.data.accommodations),$.each(e,function(a,e){var t=this.accommodation.accommodationTypeId,n=L.icon({iconUrl:"https://sc.wklcdn.com/wikiloc/images/layers/poi-"+t+".png",iconSize:[32,32],iconAnchor:[16,32],tooltipAnchor:[8,-22],zIndex:100-a}),c=L.marker([e.accommodation.latitude,e.accommodation.longitude],{icon:n,riseOnHover:!0,accommodation:e.accommodation});c.addTo(o),c.on("click",function(o){var a=this.options.accommodation;0==$("#lb-accomodation-modal").length&&($("#page").append('<div id="lb-accomodation-modal" class="modal fade"> <div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title"></h4></div><div class="modal-body"></div></div></div></div>'),$(document).on("click","#acc-contact-button",function(o){o.preventDefault(),$("#accommodation_form,#acc-contact-title,#acc-contact-cancel").show(),$("#acc-book-inner").hide()}),$(document).on("click","#acc-book-button",function(o){o.preventDefault(),bookAccommodation(),window.open($("#accommodation_reservationUrl").val())}),$(document).on("click","#acc-contact-cancel",function(o){o.preventDefault(),$("#accommodation_form,#acc-contact-title,#acc-contact-cancel").hide(),$("#acc-book-inner").show()}),$(document).on("click","#acc-navi li a",function(o){o.preventDefault(),$("#acc-photos, #acc-reviews").hide(),$("#acc-navi li").removeClass("current"),$(this).parent("li").addClass("current"),$(this.hash).show(),$("#sendFrom").focus()}),$(document).on("click",".acc-legal",function(o){$("#terms-body").show(),$("#acc-termsbody").show()})),$("#lb-accomodation-modal").on("show.bs.modal",function(){$("#lb-accomodation-modal .modal-title").html(translate("txtAccommodationPublish")+'&nbsp;<a href="/wikiloc/pois.do"><strong>'+translate("txtAccommodationEdit")+"</strong></a>"),$("#lb-accomodation-modal .modal-body").html(TemplateCache.get("#lb-accomodation-template")({accom:a})),$("#sendFrom").focus()}),$("#lb-accomodation-modal").on("shown.bs.modal",function(){Recaptcha.loadRecaptcha({el:"#submit_contact",sitekey:"6Lcc50wUAAAAAOPCb9Gz1h3UyCoIYBby5BVDuICa",callback:function(o){var a=document.createElement("input");a.type="hidden",a.name="g-recaptcha-response",a.value=o,document.querySelector("#accommodation_form").appendChild(a),sendAccommodation(),Recaptcha.unloadRecaptcha()}})}),$("#lb-accomodation-modal").on("hide.bs.modal",function(){Recaptcha.unloadRecaptcha()}),$("#lb-accomodation-modal").modal("show"),$(".accommodation_name").text(a.name),$(".accommodation_type").text(a.accommodationType),$("#accommodation_id").val(a.id),$("#accommodation_name").val(a.name),$("#accommodation_reservationUrl").val(a.reservationUrl),a.reservationUrl?($("#accommodation_form,#acc-contact-title").hide(),$("#acc-book-inner").show()):($("#accommodation_form,#acc-contact-title").show(),$("#acc-book-inner").hide()),$(".accommodation_location").attr("title",a.address).text(a.address);var e=a.url;e=a.url.substr(7),$(".accommodation_url a").attr("href",a.url).attr("title",a.url).text(e),$(".accommodation_url").show(),$("#terms-body").hide(),$("#accommodation_form .tr_error").remove(),$("#submit_contact").attr("disabled",!1),$("#accommodation_form").unbind("submit"),$("#accommodation_form").submit(function(o){o.preventDefault(),sendAccommodation()}),$("#acc-photos").show(),$("#acc-navi li").removeClass("current"),$("#acc-navi li:first").addClass("current"),$("#acc-big-photo").css("background-image",""),"pictures"in a&&($("#acc-thumbs").empty(),0==a.pictures.length?$("#acc-big-photo").css("background-image","url('https://sc.wklcdn.com/images/camera.png')"):($.each(a.pictures,function(o,a){if($('<li><a href="#" data-image="https://s0.wklcdn.com'+a.picture.urlBigSize+'" style="background-image: url(https://s0.wklcdn.com'+a.picture.urlThumbnailSize+')"></a></li>').appendTo("#acc-thumbs"),0==o&&$("#acc-big-photo").css("background-image","url(https://s0.wklcdn.com"+a.picture.urlBigSize+")"),6==o)return!1}),thumbsLoaded()))}),housesOnMap.push(c)}),$("#accommCheckIcon").removeClass("loading")}}).error(function(){$("#accommCheckIcon").removeClass("loading")})}function thumbsLoaded(){$("#acc-thumbs li a").click(function(o){o.preventDefault(),$("#acc-thumbs li").removeClass("current"),$(this).parent("li").addClass("current"),$("#acc-big-photo").css("background-image","url("+$(this).attr("data-image")+")"),$("#sendFrom").focus()})}function sendAccommodation(){$("#accommodation_form .tr_error").remove(),$("#submit_contact").attr("disabled",!1);var o=!1;$("#accommodation_form .required").each(function(a,e){""==$.trim($(e).val())?(o=!0,$("<span class='tr_error' style='color:red'>"+translate("txtRequired")+"</span>").appendTo($(e).parent("div")),$(e).parent("div").addClass("has-error")):($(e).parent("div").removeClass("has-error"),$(e).parent("div").addClass("has-success"))}),validateEmail($("#sendEmail").val())?($(el).parent("div").removeClass("has-error"),$(el).parent("div").addClass("has-success")):(o=!0,$("<span class='tr_error' style='color:red'> "+translate("txtEmailEmpty")+"</span>").appendTo($("#sendEmail").parent("div")),$(el).parent("div").removeClass("has-success"),$(el).parent("div").addClass("has-error")),o||contactAccommodation()}function validateEmail(o){var a=/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;return a.test(o)}function contactAccommodation(){$("#submit_contact").attr("disabled",!0),$("#gc_contact_working").html("<img src='https://sc.wklcdn.com/images/loading.gif'></img>");var o=$.ajax({url:"/wikiloc/sendAccommodationRequest.do",method:"post",data:{sendFrom:encodeURIComponent($("#sendFrom").val()),sendEmail:$("#sendEmail").val(),sendNumPer:$("#sendNumPer").val(),sendPhone:encodeURIComponent($("#sendPhone").val()),sendText:encodeURIComponent($("#sendText").val()),sendReferer:$("#sendReferer").val(),accommodation_id:$("#accommodation_id").val(),"g-recaptcha-response":$("input[name='g-recaptcha-response']").val()},dataType:"json"}).done(function(o){"OK"==o.res?$('<div class="messageContainer" ><div class="message big green">&nbsp;'+o.message+"&nbsp;</div></div>").insertBefore($("#sendReferer")).fadeIn("slow").animate({opacity:1},1e3).fadeOut("slow",function(){$("#lb-accomodation-modal").hide(),$(this).remove()}):"ERROR"==o.res?$('<div class="messageContainer" ><div class="message big yellow">&nbsp;'+o.message+"&nbsp;</div></div>").insertBefore($("#sendReferer")).fadeIn("slow").animate({opacity:1},2e3).fadeOut("slow",function(){$("#lb-accomodation-modal").hide(),$(this).remove()}):$("#lb-accomodation-modal").hide(),$("#accommodation_id").val(""),$("#submit_contact").attr("disabled",!1),$("#gc_contact_working").html("")});return o.fail(function(){$('<div class="messageContainer" ><div class="message big yellow">&nbsp;This action cannot be performed at the moment. Please try again later.&nbsp;</div></div>')}),!1}function bookAccommodation(){$("#gc_contact_working2").html("<img src='https://sc.wklcdn.com/images/loading.gif'></img>");var o=$.ajax({url:"/wikiloc/sendAccommodationRequest.do",method:"post",data:{sendFrom:encodeURIComponent($("#sendFrom").val()),sendReferer:$("#sendReferer").val(),accommodation_id:$("#accommodation_id").val(),accommodation_reservationUrl:$("#accommodation_reservationUrl").val()},dataType:"json"}).done(function(o){$("#gc_contact_working2").html("")});return o.fail(function(){$("#gc_contact_working2").html(""),window.open($("#accommodation_reservationUrl").val())}),!1}function loadMap(o){var a=[],e=[];for(var t in mapData.mapData){var n=mapData.mapData[t];n.waypoint?a.push({lat:n.blat,lng:n.blng,spaId:n.spaId,name:n.nom,image:n.imgOnTooltip}):e.push({twkbB64:n.geom,isLoop:n.loop})}var c,i,s,r,l,d=L.featureGroup(e.map(function(o){return L.WklTrail.fromTwkbBase64(o.twkbB64,{isLoop:o.isLoop})}).concat(a.map(function(a){var e=L.wklWaypoint([a.lat,a.lng],{spaId:a.spaId,name:a.name,image:a.image});return e.on("click",function(){o.isFullscreen()&&o.toggleFullscreen({pseudoFullscreen:!0}),$("html, body").animate({scrollTop:$("#wp-"+a.spaId).offset().top},750),window.location="#wp-"+a.spaId}),e})));"ign"===baseMap?(c=L.WklLayers.IGN_pnoa,i=L.WklLayers.IGN_topo,s="- Ortofoto PNOA (IGN)",r="- Mapa r√°ster (IGN)",l=L.i18n.switchmap.topo):"icgc"===baseMap?(c=L.WklLayers.ICGC_orto,i=L.WklLayers.ICGC_topo,s="- Ortofoto (ICGC)",r="(ICGC)",l=L.i18n.switchmap.topo):(c=L.WklLayers.MapkitHybrid,i=L.WklLayers.MapkitDefault,s="(Apple)",r="(Apple)",l=L.i18n.switchmap.map);var m=[];"hybrid"===defMapType?m.push(c):m.push(i),o=L.map("map-canvas",{layers:m,worldCopyJump:!0,maxBounds:[[-90,-(1/0)],[90,1/0]],minZoom:5}),d.addTo(o),o.on("baselayerchange",function(){if(o.hasLayer(c)){var a=new XMLHttpRequest;a.open("GET",window.origin+"/wikiloc/spatialArtifacts.do?event=saveMapViewport&mapType=hybrid",!0),a.send()}else if(o.hasLayer(i)){var a=new XMLHttpRequest;a.open("GET",window.origin+"/wikiloc/spatialArtifacts.do?event=saveMapViewport&mapType=roadmap",!0),a.send()}});var p=L.control.switchmap([],function(a){if(a.getOtherLayers().length<1){var e=o.getBounds(),t=e.getSouthWest(),n=e.getNorthEast(),d=new XMLHttpRequest;d.open("GET","/wikiloc/spatialArtifacts.do?event=getWMSList&x="+t.lng+"&y="+t.lat+"&X="+n.lng+"&Y="+n.lat,!0),d.onload=function(){if(d.status>=200&&d.status<400){var o=JSON.parse(d.responseText),e=transformData(o);a.replaceOtherLayers([{layer:c,name:L.i18n.switchmap.satellite+" "+s},{layer:i,name:l+" "+r}].concat(e))}},d.send()}},{textMoreMaps:L.i18n.switchmap.moreMaps}).addTo(o);o.addControl(new L.Control.Fullscreen({position:"topright",title:{false:"View Fullscreen",true:"Exit Fullscreen"},pseudoFullscreen:!0})),o.on("click",function(){p.closeOtherLayers()}),d.addTo(o);var u=document.querySelector("#elevation-profile"),h=0;u&&(h=u.offsetHeight),o.fitBounds(d.getBounds().pad(.01),{paddingTopLeft:[document.querySelector(".leaflet-control-zoom").offsetWidth,document.querySelector(".leaflet-top.leaflet-right").offsetHeight+34],paddingBottomRight:[document.querySelector(".leaflet-control-fullscreen").offsetWidth,h+document.querySelector(".leaflet-bottom.leaflet-right").offsetHeight],maxZoom:19}),o.on("fullscreenchange",function(){o.isFullscreen()&&loadGeopromotionLayer(o)});var f=_.debounce(function(){var a=o.getBounds(),e=d.getBounds();a.intersects(e)&&loadGeopromotionLayer(o)},500);return o.on("moveend zoomend resize",f),loadGeopromotionLayer(o),o}var housesOnMap=[],trailMap,mapCanvas=document.querySelector("#map-canvas"),observer=new IntersectionObserver(function(o){o.forEach(function(o){o.isIntersecting&&(trailMap=loadMap(trailMap),observer.unobserve(mapCanvas))})});observer.observe(mapCanvas);